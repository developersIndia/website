name: Deploy to Production

on:
  push:
    branches:
      - main

jobs:
  runCodeQualityChecks:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "16"
          cache: "npm"

      - name: Install dependecies
        run: npm ci

      - name: Format code using Prettier
        run: npm run format

      - name: Lint source code
        run: npm run lint

  # TODO: Run test suite

  runNextBuild:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "16"
          cache: "npm"

      - name: Install dependencies for Next.js Build
        run: npm ci

      - name: Run Next.js build to generate the static files
        run: npm run build

      - name: üöÄDeploy
        id: deploy-netlify
        run: |
          COMMAND="netlify deploy --build --prod"
          OUTPUT=$(sh -c "$COMMAND")

          NETLIFY_LOGS_URL=$(echo "$OUTPUT" | grep -Eo '(http|https)://app.netlify.com/[a-zA-Z0-9./?=_-]*') # Unique key: app.netlify.com
          NETLIFY_LIVE_URL=$(echo "$OUTPUT" | grep -Eo '(http|https)://[a-zA-Z0-9./?=_-]*' | grep -Ev "netlify.com|(--)") # Unique key: doesn't contain -- and app.netlify.com

          echo "::set-output name=netlify_logs_url::$NETLIFY_LOGS_URL"
          echo "::set-output name=netlify_live_url::$NETLIFY_LIVE_URL"
        env:
          NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}

      - name: üëì Netlify Preview URL
        uses: peter-evans/commit-comment@v1
        env:
            OUTPUT: "This pull request is being automatically deployed to Netlify.\n\nüîç Inspect: ${{ steps.deploy-netlify.outputs.NETLIFY_LOGS_URL }}\n‚úÖ Preview: ${{ steps.deploy-netlify.outputs.NETLIFY_URL }}"
        with:
          body: ${{ env.OUTPUT }}

      # # Publish the inspect and preview link to the PR
      # - name: üëì Netlify Preview URL
      #   uses: unsplash/comment-on-pr@master
      #   env:
      #     GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      #     OUTPUT: "This pull request is being automatically deployed to Netlify.\n\nüîç Inspect: ${{ steps.deploy-netlify.outputs.NETLIFY_LOGS_URL }}\n‚úÖ Preview: ${{ steps.deploy-netlify.outputs.NETLIFY_URL }}"
      #   with:
      #     msg: ${{ env.OUTPUT }}
      #     check_for_duplicate_msg: false

